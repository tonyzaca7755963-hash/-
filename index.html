<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>真实地球 - 稳定优化版（中文增强）</title>
    <style>
        body { margin: 0; background-color: #000; overflow: hidden; font-family: 'Microsoft YaHei', sans-serif; }
        
        /* 加载提示 (保持不变) */
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            color: #fff; font-size: 20px; pointer-events: none;
            text-shadow: 0 0 10px rgba(255,255,255,0.8);
            z-index: 1000;
        }

        /* Tooltip 样式 - 最终修复区域 */
        .scene-tooltip {
            background: rgba(0, 0, 0, 0.9) !important;
            border: 1px solid #66ccff !important;
            color: #fff !important;
            padding: 10px 15px !important;
            border-radius: 4px !important;
            box-shadow: 0 0 15px rgba(102, 204, 255, 0.5) !important;
            backdrop-filter: blur(5px);
            
            /* 【核心修复】：设置固定宽度，避免内容影响宽度计算 */
            width: 350px !important; /* 强制固定宽度，不使用max-width */
            white-space: normal !important; /* 确保文字可以换行 */
        }
        
        .tooltip-title { 
            font-size: 16px; 
            font-weight: bold; 
            color: #66ccff; 
            border-bottom: 1px solid #444; 
            padding-bottom: 5px; 
            margin-bottom: 5px; 
            white-space: normal; /* 确保标题也可以换行，如果标题很长 */
        }
        
        .tooltip-desc { 
            font-size: 12px; 
            color: #eee; 
            line-height: 1.5; 
            white-space: normal !important; 
        }
    </style>
    
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="globe.gl.min.js"></script> 
    <script src="topojson.min.js"></script> 
    <script src="countryname.js"></script>
</head>
<body>

<div id="loading">正在加载地球纹理和 TopoJSON 数据...</div>
<div id="globeViz"></div>

<script>
    // --- 2. 增强的中文国家信息数据库 (60+ 条目) ---
;

    // --- 3. 初始化地球 ---
    const world = Globe()
        (document.getElementById('globeViz'))
        .backgroundColor('#000000')
        .globeImageUrl('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg')
        .backgroundImageUrl('https://cdn.jsdelivr.net/npm/three-globe/example/img/night-sky.png') 
        .atmosphereColor('#aaddff')
        .atmosphereAltitude(0.2)
        
        .polygonCapColor(() => 'rgba(255, 255, 255, 0.05)') 
        .polygonSideColor(() => 'rgba(0, 150, 255, 0.1)') 
        .polygonStrokeColor(() => '#0088cc') 
        .polygonAltitude(0.003) // 适配 1:50m 降低高度

        // 交互效果 (悬停高亮)
        .onPolygonHover(hoverD => {
            world
                .polygonAltitude(d => d === hoverD ? 0.015 : 0.003) // 悬停浮起高度降低
                .polygonCapColor(d => d === hoverD ? 'rgba(0, 200, 255, 0.4)' : 'rgba(255, 255, 255, 0.05)') 
                .polygonStrokeColor(d => d === hoverD ? '#66ccff' : '#0088cc'); 
        })

        // 增强的显示信息 (查找中文名或使用默认信息)
        .polygonLabel(({ properties: d }) => {
            const engName = d.NAME || d.ADMIN || d.name; // 尝试 TopoJSON 中的各种英文名称键
            const data = baiduBaikeDB[engName];
            
            // 如果在数据库中找不到，则使用一个通用的中文描述
            const finalData = data || {
                name: engName, // 保持英文名作为主标题
                desc: `该地区/国家 (${engName}) 数据暂未录入。它位于地球表面。`
            };
            
            return `
                <div class="scene-tooltip">
                    <div class="tooltip-title">${finalData.name}</div>
                    <div class="tooltip-desc">${finalData.desc}</div>
                </div>
            `;
        });

    // --- 4. 加载本地 TopoJSON 文件 ---
    const TOPOJSON_URL = './world.json'; 

    fetch(TOPOJSON_URL)
        .then(res => res.json())
        .then(topology => {
            const countries = topojson.feature(topology, topology.objects.countries); 
            const filteredCountries = countries.features.filter(d => d.properties.ADMIN !== 'Antarctica');
            
            world.polygonsData(filteredCountries);
            
            document.getElementById('loading').style.display = 'none';

            world.pointOfView({ lat: 30, lng: 100, altitude: 3.0 }, 1000); 
            world.controls().autoRotate = true;
            world.controls().autoRotateSpeed = 0.3; // 调慢旋转速度
        })
        .catch(error => {
            document.getElementById('loading').innerText = "致命错误：无法加载或处理 world.json 文件！\n请确认文件已放在同目录且Live Server已启动。";
            console.error("加载 TopoJSON 失败:", error);
        });

    // --- 5. 添加飞线特效 ---
    const NUM_ARCS = 20; 
    const arcsData = [];
    for (let i = 0; i < NUM_ARCS; i++) {
        const startLat = (Math.random() - 0.5) * 180;
        const startLng = (Math.random() - 0.5) * 360;
        const endLat = (Math.random() - 0.5) * 180;
        const endLng = (Math.random() - 0.5) * 360;
        arcsData.push({
            startLat, startLng, endLat, endLng,
            color: ['rgba(102, 204, 255, 0.6)', 'rgba(102, 204, 255, 0.2)'] 
        });
    }

    world.arcsData(arcsData)
        .arcColor('color')
        .arcDashLength(0.4)
        .arcDashGap(0.2)
        .arcDashAnimateTime(1500)
        .arcAltitude(0.3) 
        .arcStroke(0.6);

    // 窗口适配
    window.addEventListener('resize', () => {
        world.width(window.innerWidth);
        world.height(window.innerHeight);
    });

</script>
</body>

</html>



